pipeline {
  agent { label 'master' }
  stages {
    stage('test') {       
      
      steps {
      script {
               if( !fileExists("/var/lib/jenkins/smoketest") ) {         
                 sh 'mkdir -p /var/lib/jenkins/smoketest'
                 }
               def status = sh(script:'curl -u admin:11cb1244bb77821dbd847aa548ececa319  http://localhost:8080/job/downstreamjob/lastBuild/api/json|jq .building', returnStdout:true).trim()
               echo (status.getClass())
               if(status) {
                  echo 600 > '/var/lib/jenkins/smoketest/delayseconds'
                  }
               else { 
                  echo 0 > '/var/lib/jenkins/smoketest/delayseconds'
                  sh 'curl -u admin:11cb1244bb77821dbd847aa548ececa319  http://localhost:8080/job/downstreamjob/build?token=my-token'              
              }
           }
      }
    }
    
    }
}
  
